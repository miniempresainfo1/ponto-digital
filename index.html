<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal de Presen√ßa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .hidden-section { display: none !important; }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen">

    <div id="loginScreen" class="flex flex-col items-center justify-center min-h-screen p-4 text-center">
        <div class="bg-white p-10 rounded-[2.5rem] shadow-2xl max-w-sm w-full border border-slate-200">
            <div class="text-6xl mb-6">üõ°Ô∏è</div>
            <h1 class="text-3xl font-black text-slate-800 mb-8 uppercase tracking-tighter">Portal de Presen√ßa</h1>
            <div class="space-y-4">
                <button onclick="acessoParticipante()" class="w-full bg-blue-600 text-white font-black py-5 rounded-2xl hover:bg-blue-700 transition shadow-lg active:scale-95">SOU PARTICIPANTE</button>
                <button onclick="acessoAdmin()" class="w-full bg-slate-800 text-white font-black py-5 rounded-2xl hover:bg-black transition shadow-lg active:scale-95">SOU ADMINISTRADOR</button>
            </div>
        </div>
    </div>

    <div id="mainContent" class="hidden-section max-w-2xl mx-auto p-4 md:p-8">
        <div class="flex justify-between items-center mb-8">
            <button onclick="window.location.reload()" class="bg-white px-5 py-2 rounded-2xl text-slate-400 text-xs font-black shadow-sm hover:text-red-500 transition">‚Üê SAIR</button>
            <span id="badgeAcesso" class="px-5 py-2 rounded-2xl text-xs font-black uppercase shadow-sm border"></span>
        </div>

        <div id="adminPanel" class="hidden-section bg-white p-8 rounded-[2rem] shadow-xl border-2 border-slate-900 mb-10">
            <h2 class="text-slate-900 font-black mb-6 uppercase italic tracking-tight">üìù Agendar Reuni√£o</h2>
            <div class="space-y-4">
                <input type="text" id="titulo" placeholder="T√≠tulo da Reuni√£o" class="w-full border-2 border-slate-100 p-4 rounded-2xl outline-none focus:border-slate-900 transition">
                <input type="datetime-local" id="data" class="w-full border-2 border-slate-100 p-4 rounded-2xl outline-none focus:border-slate-900 transition">
                <button onclick="criarReuniao()" class="w-full bg-slate-900 text-white font-black py-5 rounded-2xl hover:bg-black transition shadow-xl uppercase tracking-widest">Gerar Token 6 D√≠gitos</button>
            </div>
            <div id="listaIdsAdmin" class="mt-8 border-t pt-6">
                <p class="text-[10px] font-black text-slate-400 uppercase mb-4 tracking-widest">Gest√£o de Reuni√µes Ativas:</p>
                <div id="idsConsultar" class="space-y-3"></div>
            </div>
        </div>

        <div id="participantePanel" class="hidden-section mb-10">
            <div class="bg-white p-8 rounded-[2rem] shadow-xl border-t-8 border-blue-600 text-center">
                <h2 class="text-slate-800 font-black mb-6 uppercase tracking-tight">Digite o Token de Acesso</h2>
                <div class="flex flex-col gap-5">
                    <input type="number" id="buscaId" placeholder="000000" class="w-full border-2 border-slate-100 p-5 rounded-2xl outline-none focus:border-blue-600 text-center font-black text-5xl tracking-[0.2em] text-blue-600">
                    <button onclick="buscarReuniaoPorId()" class="w-full bg-blue-600 text-white py-5 rounded-2xl font-black text-xl hover:bg-blue-700 transition shadow-lg active:scale-95">ACESSAR LISTA</button>
                </div>
            </div>
        </div>

        <div id="listaReunioes" class="space-y-6 pb-24"></div>
    </div>

    <script>
        // --- CONFIGURA√á√ÉO SUPABASE ---
        const SUPABASE_URL = 'https://vbgztyphwwrxdmfefnnc.supabase.co'.trim();
        const SUPABASE_KEY = 'sb_publishable_goDFv_bti5TRne64uzpzoA_bFECMHlg'.trim();
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        let isAdmin = false;

        // --- NAVEGA√á√ÉO ---
        function acessoParticipante() {
            isAdmin = false;
            mudarInterface("PARTICIPANTE", "bg-blue-50 text-blue-600 border-blue-200");
            document.getElementById('participantePanel').classList.remove('hidden-section');
        }

        function acessoAdmin() {
            const pass = prompt("Senha Administrativa:");
            if (pass === "admin123") {
                isAdmin = true;
                mudarInterface("ADMINISTRADOR", "bg-slate-900 text-white border-slate-700");
                document.getElementById('adminPanel').classList.remove('hidden-section');
                carregarDadosAdmin();
            } else alert("Senha incorreta.");
        }

        function mudarInterface(tipo, estilo) {
            document.getElementById('loginScreen').classList.add('hidden-section');
            document.getElementById('mainContent').classList.remove('hidden-section');
            const b = document.getElementById('badgeAcesso');
            b.innerText = tipo;
            b.className = `px-5 py-2 rounded-2xl text-xs font-black uppercase shadow-sm border ${estilo}`;
        }

        // --- FUN√á√ïES DO BANCO (PARTICIPANTE) ---
        async function buscarReuniaoPorId() {
            const token = document.getElementById('buscaId').value;
            if (token.length < 5) return alert("Insira o token completo.");

            const { data, error } = await supabaseClient
                .from('reunioes')
                .select('*, presencas(nome_funcionario)')
                .eq('id_curto', token)
                .maybeSingle();

            const container = document.getElementById('listaReunioes');
            if (error || !data) {
                container.innerHTML = `<div class="bg-red-50 text-red-600 p-8 rounded-[2rem] text-center font-black border border-red-200">TOKEN INV√ÅLIDO OU N√ÉO EXISTE</div>`;
                return;
            }
            renderizarCardReuniao(data, container);
        }

        // --- FUN√á√ïES DO BANCO (ADMIN) ---
        async function carregarDadosAdmin() {
            // Buscamos sem ordenar por colunas que podem n√£o existir (evita Erro 400)
            const { data, error } = await supabaseClient
                .from('reunioes')
                .select('id, titulo, id_curto, presencas(nome_funcionario)');

            if (error) return console.error(error);

            document.getElementById('idsConsultar').innerHTML = data.map(r => `
                <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100 mb-2">
                    <div class="flex justify-between items-center mb-3">
                        <span class="font-black text-slate-800 text-sm uppercase truncate pr-2">${r.titulo}</span>
                        <span class="bg-blue-600 text-white px-3 py-1 rounded-xl font-mono font-bold text-lg tracking-widest">#${r.id_curto}</span>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="baixarLista('${r.titulo}', '${r.presencas.map(p => p.nome_funcionario).join('\\n')}')" class="flex-1 bg-white border border-slate-200 text-[10px] font-black py-2 rounded-xl hover:bg-slate-100 uppercase tracking-tighter">Baixar Lista</button>
                        <button onclick="excluirReuniao('${r.id}')" class="bg-red-50 text-red-500 text-[10px] font-black px-4 py-2 rounded-xl hover:bg-red-100 uppercase">Apagar</button>
                    </div>
                </div>
            `).join('');
        }

        async function criarReuniao() {
            const t = document.getElementById('titulo').value;
            const d = document.getElementById('data').value;
            const token = Math.floor(100000 + Math.random() * 900000); // 6 D√≠gitos

            if (!t || !d) return alert("Preencha t√≠tulo e data!");

            const { error } = await supabaseClient.from('reunioes').insert([{ titulo: t, data_hora: d, id_curto: token }]);
            
            if (error) alert("Erro ao criar: " + error.message);
            else {
                alert("Reuni√£o Agendada! Token: " + token);
                document.getElementById('titulo').value = '';
                carregarDadosAdmin();
            }
        }

        // --- AUXILIARES ---
        function renderizarCardReuniao(r, container) {
            const nomes = r.presencas.map(p => p.nome_funcionario).join(', ');
            container.innerHTML = `
                <div class="bg-white p-8 rounded-[2.5rem] shadow-2xl border-2 border-blue-600 animate-in zoom-in duration-300">
                    <h3 class="text-3xl font-black text-slate-800 uppercase tracking-tighter mb-1">${r.titulo}</h3>
                    <p class="text-blue-600 font-bold mb-6 italic">üìÖ ${new Date(r.data_hora).toLocaleString()}</p>
                    <div class="bg-slate-50 p-5 rounded-2xl mb-8">
                        <p class="text-[10px] font-black text-slate-400 uppercase mb-2 tracking-widest">Confirmados (${r.presencas.length}):</p>
                        <p class="text-slate-700 font-semibold">${nomes || 'Nenhum nome registrado'}</p>
                    </div>
                    <button onclick="marcarPresenca('${r.id}', ${r.id_curto})" class="w-full bg-blue-600 text-white font-black py-5 rounded-2xl hover:bg-blue-700 transition shadow-xl active:scale-95">CONFIRMAR MINHA PRESEN√áA</button>
                </div>
            `;
        }

        async function marcarPresenca(idOriginal, token) {
            const n = prompt("Digite seu nome completo:");
            if (!n) return;
            const { error } = await supabaseClient.from('presencas').insert([{ reuniao_id: idOriginal, nome_funcionario: n }]);
            if (!error) {
                document.getElementById('buscaId').value = token;
                buscarReuniaoPorId();
            } else alert("Erro ao assinar.");
        }

        function baixarLista(t, n) {
            const b = new Blob([`REUNI√ÉO: ${t}\n\nLISTA DE PRESENTES:\n${n || 'Sem registros'}`], { type: 'text/plain' });
            const u = window.URL.createObjectURL(b);
            const a = document.createElement('a');
            a.href = u; a.download = `lista_${t.replace(/\s+/g, '_')}.txt`; a.click();
        }

        async function excluirReuniao(id) {
            if (confirm("Deseja apagar permanentemente?")) {
                await supabaseClient.from('reunioes').delete().eq('id', id);
                carregarDadosAdmin();
            }
        }
    </script>
</body>
</html>